<!DOCTYPE html> 
<html> 
	<head> 
	<title>Live Results</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="apple-mobile-web-app-capable" content="yes" />-->
    <link rel="apple-touch-startup-image" href="/images/apple-touch-startup-image.png">
    <link rel="apple-touch-icon" href="/images/axtime-apple-touch-icon-57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/images/axtime-apple-touch-icon-72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/images/axtime-apple-touch-icon-114.png" /> 
	<link rel="stylesheet" href="/jquery.mobile-1.1.0.min.css" />
    <link rel="stylesheet" href="/style.css" />
	<script src="/jquery-1.7.2.min.js"></script>
	<script src="/jquery.mobile-1.1.0.min.js"></script>
    <script src="/script.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head> 
<body> 
    <div data-role="page" id="page-runs">
        <div data-role="header">
            <a href="/results" data-role="button" data-ajax="false" data-icon="arrow-l" data-reverse="true">Back</a>
            <h1>Runs</h1>
        </div>
        <div data-role="content">
            
            <p id="info" style="margin-top:4px;">Runs automatically update!<br /> # of Runs: <strong><span id="runcount">-</span></strong> -  Updated: <strong><span id="lastupdated">-</span></strong> </p>
         

            <ul id="runslist" data-role="listview" data-divider-theme="e">
                <li>Loading...</li>
            </ul>
        </div>
        <div data-role="footer" data-position="fixed" data-id="footerbar" class="custom-icons">
            <div data-role="navbar" class="custom-icons">
                <ul>
                    <li><a href="/results#dlg-carsearch" class="nb-carsearch" data-ajax="false" data-rel="dialog" data-role="button" data-transition="none" data-icon="custom">Car Search</a></li>
                    <li><a href="/results#page-ttod" class="nb-ttod" data-ajax="false" data-role="button" data-transition="none" data-icon="custom">TTOD</a></li>
                    <li><a href="/runs" class="nb-runs ui-btn-active" data-ajax="false" data-role="button" data-transition="none" data-icon="custom">Runs</a></li>
                    <li><a href="/results#page-results" class="nb-results" data-ajax="false" data-transition="none" data-icon="custom">Results</a></li>
                </ul>

            </div>
        </div>  
        <script type="text/javascript">

            var host = $.mobile.path.parseUrl(window.location.href)
                , runs = []
                , showRuns = 10;
            
            function handleResults(data) {
                $('<div class="ui-loading ui-loader ui-loader-verbose ui-overlay-shadow ui-body-b ui-corner-all"><span class="ui-icon ui-icon-loading"></span><h1>Updating data</h1></div>')
                .css({ 'display': 'block', 'opacity': 0.96, 'margin-left': '0', 'margin-top': '0'
                    , 'top': 100
                    , 'left': $(window).width() / 2 - 100
                }).appendTo($.mobile.pageContainer)
                .delay(100)
                .fadeOut(400, function () {
                    $(this).remove();
                });
                runs = data.runs;
                lastpoll = data.lastpoll;
                totalruns = data.runcount;
                genRuns();
                $('#lastupdated').text(lastpoll);
                $('#runcount').text(totalruns);
            }

//            function genRuns() {
//                var cnt = runs.length
//                    , max = cnt - showRuns
//                    , html=[];

//                max = max < 0 ? 0 : max;

//                html.push('<li data-role="list-divider">Last ' + showRuns + ' Runs</li>');

//                for (var i = cnt-1; i >= max; i--) {
//                    var r = runs[i];
//                    var s = '<li data-theme="' + (r.isDnf ? 'a' : r.getRerun ? 'e' : '') + '"><a href="/driver?cn=' + r.car.number + '&dn=' + r.driver + '" data-ajax="false">'
//                     + '<div style="position:absolute;font-size:50px;opacity:.3;right:20%;font-style:italic;">' + r.car.number + '</div>'
//                     + '<h3 class="ui-li-heading">' + r.driver + ' - ' + r.time + '</h3>'
//                     + '<p class="ui-li-desc">Cones: <strong>' + r.cones + '</strong>, PAX: <strong>' + r.timepaxed + '</strong>, Class: <strong>' + r.axclass + '</strong></p>';
//                    if (r.isDnf) {
//                        s += '<p class="ui-li-count">DNF</p>';
//                    } else if (r.getRerun) {
//                        s += '<p class="ui-li-count">RERUN</p>';
//                    }

//                     s+= '</a></li>';
//                    html.push(s);
//                }

//                $('#runslist').empty().html(html.join('')).listview('refresh');
//            }

            var socket = io.connect('http://' + host.host);
            socket.emit('runs', { doit: true });
            socket.on('runs', handleResults);


//            function run() {
//                return {
//                    n: 0, axclass: '', driver: '', car: { description: '', number: '', year: 0, color: '' }, rawtime: 0.0
//                    , cones: 0, isDnf: false, getRerun: false, tod: 0, time: 0, timepaxed: 0
//                };
//            }

        </script>
    </div>
</body>
</html>
