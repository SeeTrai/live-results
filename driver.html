<!DOCTYPE html> 
<html> 
	<head> 
	<title>Live Results</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
    <!--<meta name="apple-mobile-web-app-capable" content="yes" />-->
    <link rel="apple-touch-startup-image" href="/images/apple-touch-startup-image.png">
    <link rel="apple-touch-icon" href="/images/axtime-apple-touch-icon-57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/images/axtime-apple-touch-icon-72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/images/axtime-apple-touch-icon-114.png" />
	<link rel="stylesheet" href="/jquery.mobile.css" />
    <link href="/style.css" rel="stylesheet" type="text/css" />
	<script src="/jquery-1.7.1.js"></script>
	<script src="/jquery.mobile.js"></script>
    <script src="/script.js"></script>
    
</head> 
<body> 
    <div data-role="page">
        <div data-role="header">
            
            <a href="/index" data-role="button" data-ajax="false" data-icon="home" data-reverse="true">Home</a>
            <h1 id="drivername">Live Results</h1>
            <a id="refreshtimes" data-role="button" data-ajax="false" data-icon="refresh" data-theme="b">Refresh</a>
        </div>

        <div data-role="content">
           <div style="text-align:center;" class="logo-horiz"></div>
           <!--<p><a href="/results" data-theme="b" data-role="button" data-ajax="false" data-icon="arrow-l">Back to Live Results</a></p>-->
           <p id="info"># of Runs: <strong><span id="runcount">-</span></strong> -  Last Updated: <strong><span id="lastupdated">-</span></strong></p>
           <p id="driverinfo"></p>
            <div class="ui-grid-b"><div class="ui-block-a">Overall<div style="text-align:center;font-size:50px;font-weight:bold;"><span id="rankoverall">-</span></div></div>
            <div class="ui-block-b">Class<div style="text-align:center;font-size:50px;font-weight:bold;"><span id="rankclass">-</span></div></div>
            <div class="ui-block-c">PAX<div style="text-align:center;font-size:50px;font-weight:bold;"><span id="rankpax">-</span></div></div>
            </div>
            <ul data-role="listview" id="dtlegend" data-inset="true" data-divider-theme="d">
                <li data-role="list-divider">Legend</li>
                <li data-theme="b" data-icon="check"><a href="#">Best Time</a></li>
                <li data-theme="a" data-icon="delete"><a href="#">DNF</a></li>
                <li data-theme="e" data-icon="alert"><a href="#">Gets A Rerun</a></li>
            </ul>
            <ul data-role="listview" id="drivertimes" data-inset="true" data-divider-theme="d">
                <li data-role="list-divider">Times</li>
            </ul>
        </div>
        
        <div data-role="footer" data-position="fixed" data-id="footerbar" class="custom-icons">
            <div data-role="navbar" class="custom-icons">
                <ul>
                    <li><a href="/results#dlg-carsearch" data-ajax="false" class="nb-carsearch" data-rel="dialog" data-role="button" data-transition="none" data-icon="custom">Car Search</a></li>
                    <li><a href="/results#page-ttod" class="nb-ttod" data-ajax="false" data-role="button" data-transition="none" data-icon="custom">TTOD</a></li>
                    <li><a href="/runs" class="nb-runs" data-ajax="false" data-ajax="false" data-role="button" data-transition="none" data-icon="custom">Runs</a></li>
                    <li><a href="/results" data-ajax="false" class="nb-results" data-transition="none" data-icon="custom">Results</a></li>
                </ul>

            </div>
        </div>  
        
    <script type="text/javascript">
        var lastpoll = 'na', totalruns = 0
            , driver=null, runs=[];
        var cn = getParameterByName('cn')
        dn = getParameterByName('dn');
      
        function reloadDriver() {
            $.ajax({
                url: '/driverdata?' + new Date().getTime()
                , data: {cn:cn, dn:dn}
                , dataType: 'json'
                , success: function (d) {
                    driver = d.driver;
                    runs = d.runs;
                    lastpoll = d.lastupdated;
                    totalruns = d.runcount;
                    gen();
                }
                , error: function (r, s, et) {
                    //console.log(s);
                }
            });
        }

        function gen() {
            var html = [];
            for (var i = 0; i < runs.length; i++) {

                var r = runs[i];
                var theme = r.isDnf ? ' data-theme="a" data-icon="delete"' : (r.getRerun ? ' data-theme="e" data-icon="alert"' : ' data-icon="false"');

                if (driver.best == r.time) {
                    theme = ' data-theme="b" data-icon="check"';
                }

                html.push('<li' + theme + '><a href="#">' + r.time + '<span class="ui-li-count">' + r.cones + '</span></a></li>');

            }

            $('#drivertimes').html('<li data-role="list-divider">Times</li>' + html.join('')).listview('refresh');
            $('#rankclass').text(ranktext(driver.rankc));
            $('#rankoverall').text(ranktext(driver.ranko));
            $('#rankpax').text(ranktext(driver.rankp));
            $('#drivername').text(driver.name);
            $('#lastupdated').text(lastpoll);
            $('#runcount').text(runs.length);
            $('#driverinfo').html('Car: <strong>' + (driver.car.year > 0 ? driver.car.year + ' ' : '') + driver.car.description + '</strong><br/>Number: <strong>' + driver.car.number + '</strong>');
        }

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.location.search);
            if (results == null)
                return "";
            else
                return decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function ranktext(n) {
            if (n == 1) { return '1st'; }
            else if (n == 2) { return '2nd'; }
            else if (n == 3) { return '3rd'; }
            else { return n + 'th'; }
        }
        $(function () {
            $('#refreshtimes').click(function () {
                reloadDriver();    
            });
            reloadDriver();
        });
        

        
</script>
    </div>

</body>
</html>
